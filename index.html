<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Number of artist per country</title>
    <link rel="stylesheet" href="dataviz.css">
    <link rel="stylesheet" href="style/bootstrap.min.css">

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script src="bubble_map.js"></script>
</head>

<body>
<div class="top">
    <img src="universite_cote_d_azur.png" alt="UniversitÃ© logo" class="logo">
</div>
<script src="dounught.js"></script>

<div style="width: 100%">
    <div style="width: 10%">
        <svg id="my_dataviz_legend"></svg>
    </div>
    <div style="width: 90%">
        <svg id="my_dataviz"></svg>
    </div>
</div>

<!--<div class="doughnut">-->
<!--    <div class="mx-auto col-12 text-center">-->
<!--        <h5 class="mt-5 mb-0">Repartition of genres for <span id="country_name"></span></h5>-->
<!--        <div id="pie" class="mt-4 mb-0"></div>-->
<!--        <div class="legend-pie col-12 mb-2">-->

<!--            <div class="d-inline"><i class="fas fa-circle strongly-like"></i> Strongly like</div>-->
<!--            <div class="d-inline mx-3"><i class="fas fa-circle like"></i> Like</div>-->
<!--            <div class="d-md-inline">-->
<!--                <div class="d-inline mr-3"><i class="fas fa-circle dislike"></i> Dislike</div>-->
<!--                <div class="d-inline mr-3"><i class="fas fa-circle strongly-dislike"></i> Strongly dislike</div>-->
<!--                <div class="d-inline"><i class="fas fa-circle unsure"></i> Unsure</div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->
<script src="pieChart.js"></script>

<script>
    var format = d3.format(",")
    datasetName_by_year = "https://raw.githubusercontent.com/JeanElisee/test/main/country.csv"
    datasetName_normal = "country_2.csv"
    selectedCountry = ""

    var colorSelect = d3.select("#select-filter")
        .on("change", function () {
            let colorOption = colorSelect.property('value')
            console.log(colorOption);

            if (!colorOption) {
                return;
            }

            d3.selectAll('g')
                .transition()
                .duration(300)
                .style('fill', function (d) {
                    console.log(d);

                    if (colorOption === 'below') {
                        return d.total > 20 ? "GoldenRod" : "white"
                    }
                    // if (!d.children) {
                    //     if (colorOption == "greater") {
                    //         return d.data.size > 1000 ? "GoldenRod" : "white"
                    //     } else {
                    //         return d.data.name.startsWith('A') ? "LightCoral" : "white"
                    //     }
                    // } else {
                    //     return "null"
                    // }
                })
        })

    // Set tooltips
    var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function (d) {
            if (d.total > 0)
                return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>Artist: </strong><span class='details'>" + format(d.total) + "</span>";
            else
                return "<strong>" + d.properties.name.toUpperCase() + "</strong> - NO INFOS"
        })

    var margin = {top: -250, right: 0, bottom: 0, left: -80},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append('g')
        .attr('class', 'map');

    var projection = d3.geoMercator()
        .scale(130)
        .translate([width / 2, height / 1.5]);

    var path = d3.geoPath().projection(projection);

    svg.call(tip);

    // Legend creation
    var legend = svg.append('g')
        .attr('transform', 'translate(5, 150)');

    const legendCellSize = 25,
        colors = d3.schemeBlues[7];

    var legendScale = d3.scaleLinear().domain([0, 20000])
        .range([0, colors.length * legendCellSize]);

    // Data and color scale
    var data = d3.map();
    var colorScale = d3.scaleThreshold()
        .domain([1, 20, 100, 1000, 7000, 50000])
        .range(d3.schemeBlues[7]);

    // Load external data and boot
    setDataset(datasetName_normal)

    var dataset = []

    function setDataset(datasetName) {
        d3.queue()
            .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
            .defer(d3.csv, datasetName, function (d) {
                dataset.push(d);
                data.set(d.id, +d.size);
            })
            .await(ready);
    }

    function ready(error, topo) {
        // Draw the map
        // Adding the title on the visualisation
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 50)
            .attr("text-anchor", "middle")
            .style("fill", "#4693c4")
            .style("font-weight", "300")
            .style("font-size", "20px")
            .text("Number of artist per country".toUpperCase());

        svg.append("text")
            .attr("x", (width / 3))
            .attr("y", 70)
            .attr("dy", ".35em")
            .text("This graph shows the repartition of artist per country.");

        svg.append("g")
            .selectAll("path")
            .data(topo.features)
            .enter()
            .append("path")
            // draw each country
            .attr("d", path)
            // set the color of each country
            .attr("fill", function (d) {
                d.total = data.get(d.id) || 0;
                return colorScale(d.total);
            })
            .style('stroke', 'white')
            .style('stroke-width', 1.5)
            .style("opacity", 0.8)
            // tooltips
            .style("stroke", "white")
            .style('stroke-width', 0.3)
            .on('mouseover', function (d) {
                tip.show(d);

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "#000")
                    .style("stroke-width", 2);
            })
            .on('mouseout', function (d) {
                tip.hide(d);

                d3.select(this)
                    .style("opacity", 0.8)
                    .style("stroke", "white")
                    .style("stroke-width", 0.3);
            })
            .on("click", function (d) {
                console.log(d);

                var index = findWithAttr(dataset, 'id', d.id);

                if (index === -1) {
                    console.log('Not found');
                    return;
                }

                selectedCountry = dataset[index];
                document.getElementById("country_name").innerHTML = selectedCountry.name.toUpperCase();
                var currentGenres = selectedCountry.genres

                if ((currentGenres && currentGenres.length === 0) || !currentGenres) {
                    console.log('No genres found');
                    return;
                }

                changeData(JSON.parse(currentGenres.replace(/'/g, '"')))
            });

        // To handle the cursor movements on the legend
        legend.selectAll()
            .data(d3.range(colors.length))
            .enter().append('svg:rect')
            .attr('height', legendCellSize + 'px')
            .attr('width', legendCellSize + 'px')
            .attr('x', 5)
            .attr('y', d => d * legendCellSize)
            .style("fill", d => colors[d])
            .on("mouseover", function (d) {
                legend.select("#cursor")
                    .attr('transform', 'translate(' + (legendCellSize + 5) + ', ' + (d * legendCellSize) + ')')
                    .style("display", null);
                d3.selectAll("path[fill='" + colors[d] + "']")
                    .style('fill', "#FFFF00");
            })
            .on("mouseout", function (d) {
                legend.select("#cursor")
                    .style("display", "none");
                d3.selectAll("path[fill='" + colors[d] + "']")
                    .style('fill', colors[d]);
            });

        legend.selectAll()
            .attr('x', 10)
            .attr('y', d => d * legendCellSize)
            .style("fill", d => colors[d]);

        svg.append("g")
            .data([topo.features])
            .attr('transform', 'translate(42, 150)')
            .call(d3.axisRight(legendScale).ticks(7));
    }


    function findWithAttr(array, attr, value) {
        for (let i = 0; i < array.length; i += 1) {
            if (array[i][attr] === value) {
                return i;
            }
        }
        return -1;
    }
</script>
</body>
