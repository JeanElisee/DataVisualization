<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Number of artist per country</title>
    <style>

        .names {
            fill: none;
            stroke: #fff;
            stroke-linejoin: round;
        }

        /* Tooltip CSS */
        .d3-tip {
            line-height: 1.5;
            font-weight: 400;
            font-family: "avenir next", Arial, sans-serif;
            padding: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: #FFF;
            border-radius: 1px;
            pointer-events: none;
        }

        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 8px;
            width: 100%;
            line-height: 1.5;
            color: rgba(0, 0, 0, 0.6);
            position: absolute;
            pointer-events: none;

        }

        /* Northward tooltips */
        .d3-tip.n:after {
            content: "\25BC";
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
            text-align: center;
        }

        /* Eastward tooltips */
        .d3-tip.e:after {
            content: "\25C0";
            margin: -4px 0 0 0;
            top: 50%;
            left: -8px;
        }

        /* Southward tooltips */
        .d3-tip.s:after {
            content: "\25B2";
            margin: 0 0 1px 0;
            top: -8px;
            left: 0;
            text-align: center;
        }

        /* Westward tooltips */
        .d3-tip.w:after {
            content: "\25B6";
            margin: -4px 0 0 -1px;
            top: 50%;
            left: 100%;
        }

        /*    text{
              pointer-events:none;
            }*/

        .details {
            color: white;
        }

    </style>

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script src="bubble_map.js"></script>
</head>

<body>
<form>
    <select id="select-color" style="position: absolute; top: 40px; left: 100px">
        <option value="" selected>Select a filter</option>
        <option value="greater">Number of artists greater than 20</option>
        <option value="below">Number of artists below 20</option>
    </select>

    <!--    <div id="select-color" style="position: absolute; top: 60px; right: 200px">-->
    <!--        <p>Select a filter:</p>-->
    <!--        <input type="radio" id="below_20" name="filter" value="below_20">-->
    <!--        <label for="below_20">Number of artists greater than 20</label><br>-->
    <!--        <input type="radio" id="greater_20" name="filter" value="greater_20">-->
    <!--        <label for="greater_20">Number of artists below 20</label><br>-->
    <!--    </div>-->
</form>

<!-- Create an element where the map will take place -->
<svg id="my_dataviz" width="100" height="100"></svg>

<script>
    var format = d3.format(",");

    var colorSelect = d3.select("#select-color")
        .on("change", function () {
            let colorOption = colorSelect.property('value')

            if (!colorOption) {
                return;
            }

            d3.selectAll('g')
                .transition()
                .duration(750)
                .style('fill', function (d) {
                    console.log(d);
                    return d;
                    // if (!d.children) {
                    //     if (colorOption == "greater") {
                    //         return d.data.size > 1000 ? "GoldenRod" : "white"
                    //     } else {
                    //         return d.data.name.startsWith('A') ? "LightCoral" : "white"
                    //     }
                    // } else {
                    //     return "null"
                    // }
                })
        })

    // Set tooltips
    var tip = d3.tip()
        .attr('class', 'd3-tip')
        .offset([-10, 0])
        .html(function (d) {
            if (d.total > 0)
                return "<strong>Country: </strong><span class='details'>" + d.properties.name + "<br></span>" + "<strong>Artist: </strong><span class='details'>" + format(d.total) + "</span>";
            else
                return "<strong>" + d.properties.name.toUpperCase() + "</strong> - NO INFOS"
        })

    var margin = {top: -250, right: 0, bottom: 0, left: -80},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var svg = d3.select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append('g')
        .attr('class', 'map');

    var projection = d3.geoMercator()
        .scale(130)
        .translate([width / 2, height / 1.5]);

    var path = d3.geoPath().projection(projection);

    svg.call(tip);

    // Legend creation
    var legend = svg.append('g')
        .attr('transform', 'translate(5, 150)');

    const legendCellSize = 25,
        colors = d3.schemeBlues[7];

    var legendScale = d3.scaleLinear().domain([0, 20000])
        .range([0, colors.length * legendCellSize]);

    // Data and color scale
    var data = d3.map();
    var colorScale = d3.scaleThreshold()
        .domain([1, 20, 100, 1000, 7000, 50000])
        .range(d3.schemeBlues[7]);

    // Load external data and boot
    d3.queue()
        .defer(d3.json, "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")
        .defer(d3.csv, "https://raw.githubusercontent.com/JeanElisee/test/main/country.csv", function (d) {
            data.set(d.id, +d.value);
        })
        .await(ready);

    function ready(error, topo) {
        // Draw the map
        // Adding the title on the visualisation
        svg.append("text")
            .attr("x", (width / 2))
            .attr("y", 50)
            .attr("text-anchor", "middle")
            .style("fill", "#4693c4")
            .style("font-weight", "300")
            .style("font-size", "20px")
            .text("Number of artist per country".toUpperCase());

        svg.append("text")
            .attr("x", (width / 3))
            .attr("y", 70)
            .attr("dy", ".35em")
            .text("This graph show the repartition of artist per country.");

        svg.append("g")
            .selectAll("path")
            .data(topo.features)
            .enter()
            .append("path")
            // draw each country
            .attr("d", path)
            // set the color of each country
            .attr("fill", function (d) {
                d.total = data.get(d.id) || 0;
                return colorScale(d.total);
            })
            .style('stroke', 'white')
            .style('stroke-width', 1.5)
            .style("opacity", 0.8)
            // tooltips
            .style("stroke", "white")
            .style('stroke-width', 0.3)
            .on('mouseover', function (d) {
                tip.show(d);

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "#000")
                    .style("stroke-width", 2);
            })
            .on('mouseout', function (d) {
                tip.hide(d);

                d3.select(this)
                    .style("opacity", 0.8)
                    .style("stroke", "white")
                    .style("stroke-width", 0.3);
            });

        // svg.append("path")
        //     .datum(topojson.mesh(data.features, function (a, b) {
        //         return a.id !== b.id;
        //     }))
        //     .datum(topojson.mesh(data.features, function (a, b) {
        //         return a !== b;
        //     }))
        //     .attr("class", "names")
        //     .attr("d", path);


        // To handle the cursor movements on the legend
        legend.selectAll()
            .data(d3.range(colors.length))
            .enter().append('svg:rect')
            .attr('height', legendCellSize + 'px')
            .attr('width', legendCellSize + 'px')
            .attr('x', 5)
            .attr('y', d => d * legendCellSize)
            .style("fill", d => colors[d])
            .on("mouseover", function (d) {
                legend.select("#cursor")
                    .attr('transform', 'translate(' + (legendCellSize + 5) + ', ' + (d * legendCellSize) + ')')
                    .style("display", null);
                d3.selectAll("path[fill='" + colors[d] + "']")
                    .style('fill', "#FFFF00");
            })
            .on("mouseout", function (d) {
                legend.select("#cursor")
                    // Change the ID of the path in order to match with the code
                    .style("display", "none");
                d3.selectAll("path[fill='" + colors[d] + "']")
                    .style('fill', colors[d]);
            });

        legend.selectAll()
            .attr('x', 10)
            .attr('y', d => d * legendCellSize)
            .style("fill", d => colors[d]);

        svg.append("g")
            .data(topo.features)
            .attr('transform', 'translate(42, 150)')
            .call(d3.axisRight(legendScale).ticks(7));
    }
</script>
</body>
